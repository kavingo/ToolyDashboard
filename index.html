<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script>
const qs  = new URLSearchParams(location.search);
const raw = qs.get("data");

if (!raw) {
  status.textContent = "❌ No embed data in URL";
  throw "no data";
}

let payload;
try {
  /* ---------------------------------------------------------
     was:  pako.inflateRaw(buf)   ← wrong
     now:  pako.inflate(buf)      ← works with zlib header
  ---------------------------------------------------------- */
  const packed  = atob(raw.replace(/-/g,'+').replace(/_/g,'/'));
  const buf     = Uint8Array.from(packed, c => c.charCodeAt(0));
  const jsonStr = new TextDecoder().decode(pako.inflate(buf));
  payload       = JSON.parse(jsonStr);
} catch (e) {
  status.textContent = "❌ Corrupt data blob";
  throw e;
}

/* ---------- small key clean-ups ---------- */
const emb = payload.embed || {};
title.value   = emb.title       || "";
desc.value    = emb.description || "";
footer.value  = emb.footer      || "";
token.value   = payload.token   || "";      /* auto-filled now */
channel.value = payload.channel || "";

send.onclick = async () => {
  if (!token.value || !channel.value) {
     status.textContent = "Fill in token & channel";
     return;
  }
  const newEmb = {
    title:       title.value,
    description: desc.value,
    footer:      { text: footer.value },
    /* colour key became colour → color in the blob, keep that */
    color:       emb.color || 0
  };
  const res = await fetch("/.netlify/functions/send-embed", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
          token:   token.value.trim(),
          channel: channel.value.trim(),
          embed:   newEmb
      })
  });
  status.textContent = await res.text();
};
</script>
